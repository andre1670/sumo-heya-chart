<!DOCTYPE HTML>
<html lang="en">
<html>
  <head>
    <meta charset="utf-8">
    <script>

window.onload = function() {

  const HEYA_COUNT = 43;

  // Initialize array of dataPoint arrays with no sekitori
  var dps = Create2DArray(HEYA_COUNT + 1);

  // Initialize array of dataPoint arrays with sekitori
  var dpsB = Create2DArray(HEYA_COUNT + 1);

  var heyaNames = ["All", "Arashio", "Asahiyama", "Asakayama", "Dewanoumi",
    "Fujishima", "Futagoyama", "Hakkaku", "Hanaregoma", "Irumagawa",
    "Isegahama", "Isenoumi", "Kasugano", "Kataonami", "Kise", 
    "Kokonoe", "Michinoku", "Minato", "Miyagino", "Musashigawa", 
    "Naruto", "Nishiiwa", "Nishikido", "Nishonoseki", "Oitekaze", 
    "Onoe", "Onomatsu", "Oshima", "Oshiogawa", "Otake", 
    "Sadogatake", "Sakaigawa", "Shibatayama", "Shikihide", "Shikoroyama", 
    "Tagonoura", "Takadagawa", "Takasago", "Takekuma", "Tamanoi",
    "Tatsunami", "Tokitsukaze", "Tokiwayama", "Yamahibiki"
  ];

  var colorsOrdered = ["#d92121", "#ff6666", "#d95321", "#ff9066", "#d98521",
    "#ffae4d", "#b39c36", "#d9b721", "#a7b336", "#c8d921", "#85b336", "#96d921",
    "#63b336", "#64d921", "#31d921", "#5dff4d", "#21d942", "#4dff6d", "#21d974",
    "#4dff9e", "#21d9a6", "#33ffc7", "#21d9d9", "#33ffff", "#21a7d9", "#66d5ff",
    "#2174d9", "#66acff", "#2142d9", "#6682ff", "#3121d9", "#7466ff", "#6321d9",
    "#9e66ff", "#9621d9", "#c766ff", "#c821d9", "#f166ff", "#d921b7", "#ff80e8",
    "#d92185", "#ff66b9", "#d92153", "#ff4d7d"
  ]

  var colorsShuffled = ["#d95321", "#ff66b9", "#9e66ff", "#96d921", "#5dff4d",
    "#66acff", "#21d942", "#ff4d7d", "#66d5ff", "#21a7d9", "#c821d9", "#33ffff",
    "#6682ff", "#21d9a6", "#7466ff", "#ff9066", "#d92121", "#6321d9", "#33ffc7",
    "#ff80e8", "#d92153", "#d9b721", "#4dff9e", "#d921b7", "#d92185", "#ff6666",
    "#4dff6d", "#63b336", "#21d974", "#64d921", "#b39c36", "#31d921", "#21d9d9",
    "#c8d921", "#a7b336", "#9621d9", "#f166ff", "#85b336", "#2142d9", "#ffae4d",
    "#2174d9", "#c766ff", "#3121d9", "#d98521"
  ]

  CanvasJS.addColorSet("heyaColors", colorsShuffled);

  var minXValue = document.getElementById("minXValue");
  var maxXValue = document.getElementById("maxXValue");

  var chart = new CanvasJS.Chart("chartContainer");

  chart.options = {
    colorSet: "heyaColors",
    //theme: "dark1",
    //backgroundColor: "transparent", // #fffedf
    animationEnabled: true,
    exportEnabled: true,
    zoomEnabled: true,
    zoomType: "x",
    rangeChanged: function(e) {
      if (e.trigger === "reset") {
        minXValue.setAttribute("value",
          CanvasJS.formatDate(e.chart.axisX[0].viewportMinimum, "YYYY.MM"));
        maxXValue.setAttribute("value",
          CanvasJS.formatDate(e.chart.axisX[0].viewportMaximum, "YYYY.MM"));
      } else {
        minXValue.setAttribute("value",
          CanvasJS.formatDate(e.axisX[0].viewportMinimum, "YYYY.MM"));
        maxXValue.setAttribute("value",
          CanvasJS.formatDate(e.axisX[0].viewportMaximum, "YYYY.MM"));
      }
    }
  };

  chart.options.title = {
    text: "Description"
  };

  chart.options.axisX = {
    title: "date",
    labelFontFamily: "Arial",
    labelFontSize: 14,
    titleFontSize: 20,
    tickLength: 5,
    lineColor: "black",
    //viewportMinimum: new Date(1898, 5),
    //viewportMaximum: new Date(2022, 7),
    margin: 0,
    //labelFormatString: "YYYY MM"
    //interval: 5,
    //intervalType: "year",
    labelFormatter: function(e) {
      return CanvasJS.formatDate(e.value, "YYYY.MM");
    }
  };

  chart.options.axisX.stripLines = [];

  chart.options.axisX.stripLines[0] = {
    //value: new Date(1988, 1),
    startValue: new Date(1757, 9),
    endValue: new Date(1988, 1),
    color: "red",
    opacity: .08
  };
  chart.options.axisX.stripLines[1] = {
    startValue: new Date(1757, 9),
    endValue: new Date(1934, 2),
    color: "red",
    opacity: .08
  };

  chart.options.axisX.crosshair = {
    enabled: true,
    snapToDataPoint: true,
    color: "green",
    valueFormatString: "YYYY.MM",
    lineDashType: "longDash",
    labelBackgroundColor: "green"
  }

  chart.options.axisY = {
    title: "total rikishi",
    labelFontFamily: "arial",
    labelFontSize: 14,
    titleFontSize: 20,
    //titleFontColor: "red",
    includeZero: true,
    tickLength: 0,
    lineColor: "black",
    gridColor: "#A9A9A9"
  };

  chart.options.legend = {
    cursor: "pointer",
    fontSize: 16,
    fontWeight: "normal",
    horizontalAlign: "center",
    itemWidth: 125,
    //dockInsidePlotArea: true,
    itemmouseover: function(e) {
      e.dataSeries.lineThickness = 3;
      e.dataSeries.fillOpacity = .6;
      e.dataSeries.indexLabelFontWeight = "bolder";
      e.chart.render();
    },
    itemmouseout: function(e) {
      e.dataSeries.lineThickness = 2;
      e.dataSeries.fillOpacity = .4;
      e.dataSeries.indexLabelFontWeight = "normal";
      e.chart.render();
    },
    itemclick: function(e) {
      if (typeof(e.dataSeries.visible) === "undefined" || e.dataSeries.visible)
        e.dataSeries.visible = false;
      else
        e.dataSeries.visible = true;

      e.chart.render();

      minXValue.setAttribute("Value",
        CanvasJS.formatDate(e.chart.axisX[0].viewportMinimum, "YYYY.MM"));
      maxXValue.setAttribute("Value",
        CanvasJS.formatDate(e.chart.axisX[0].viewportMaximum, "YYYY.MM"));
    }
  };

  chart.options.toolTip = {
    shared: false,
    cornerRadius: 8,
    //borderColor: "black",
    contentFormatter: tooltipNoSekitori
  };

  chart.options.data = [];

  for (var i = 0; i <= HEYA_COUNT; i++) {
    chart.options.data[i] = {
      name: heyaNames[i],
      type: "line",
      markerSize: 0,
      visible: false,
      cursor: "pointer",
      showInLegend: true,
      indexLabelFontSize: 12,
      legendMarkerType: "square",
      indexLabelFormatter: getHeyaLabels,
      click: function(e) {
        window.open(e.dataPoint.url);
      },
      dataPoints: dps[i]
    };
  }


  function Create2DArray(rows) {
    var arr = [];

    for (var i = 0; i < rows; i++) {
      arr[i] = [];
    }

    return arr;
  }

  function getHeyaLabels(e) {
    if (e.index !== 1 && e.dataPoint.label)
      return e.dataPoint.label;
    else return "";
  }

  // Checkbox for toggling between sekitori and sekitoriless dataSeries
  var sekitoriCheckbox = document.querySelector("input[name=checkbox]");
  sekitoriCheckbox.addEventListener("change", toggleSekitori);

  function toggleSekitori() {
    if (this.checked) {
      for (var i = 0; i <= HEYA_COUNT; i++) {
        chart.data[i].set("type", "rangeArea");
        chart.options.data[i].dataPoints = dpsB[i];
      }
      chart.options.toolTip.contentFormatter = tooltipSekitori;
    } else {
      for (var i = 0; i <= HEYA_COUNT; i++) {
        chart.data[i].set("type", "line");
        chart.options.data[i].dataPoints = dps[i];
      }
      chart.options.toolTip.contentFormatter = tooltipNoSekitori;
    }
    chart.render();
  }


  function tooltipNoSekitori(e) {
    var str = "";

    for (var i = 0; i < e.entries.length; i++) {
      var temp = CanvasJS.formatDate(e.entries[i].dataPoint.x, "YYYY.MM") +
        " - <strong>" + e.entries[i].dataSeries.name + "</strong>";
      if (e.entries[i].dataPoint.prevHeyaName !== "")
        temp = temp + "<br/>(then " + e.entries[i].dataPoint.prevHeyaName + ")";
      if (e.entries[i].dataPoint.shisho !== "")
        temp = temp + "<br/>Shisho: " + e.entries[i].dataPoint.shisho;

      temp = temp + "<br/><strong>" + e.entries[i].dataPoint.y +
        "</strong> rikishi";
      str = str.concat(temp);
    }

    return str;
  }


  function tooltipSekitori(e) {
    var str = "";

    for (var i = 0; i < e.entries.length; i++) {
      var temp = CanvasJS.formatDate(e.entries[i].dataPoint.x, "YYYY.MM") +
        " - <strong>" + e.entries[i].dataSeries.name + "</strong>";
      if (e.entries[i].dataPoint.prevHeyaName !== "")
        temp = temp + "<br/>(then " + e.entries[i].dataPoint.prevHeyaName + ")";
      if (e.entries[i].dataPoint.shisho !== "")
        temp = temp + "<br/>Shisho: " + e.entries[i].dataPoint.shisho;

      temp = temp + "<br/><strong>" + e.entries[i].dataPoint.y[0] +
        "</strong> rikishi, <strong>" + (e.entries[i].dataPoint.y[0] -
          e.entries[i].dataPoint.y[1]) + "</strong> sekitori<br/>";
      str = str.concat(temp);
    }

    return str;
  }


  $.get("https://raw.githubusercontent.com/andre1670/andre1670/main/chart.csv",
    getDataPointsFromCSV);

  function getDataPointsFromCSV(csv) {
    var csvLines = heya = dates = [];
    var hData = Create2DArray(HEYA_COUNT + 1);

    csvLines = csv.split(/[\r?\n|\r|\n]+/);
    for (var i = 1; i < csvLines.length; i++) {
      if (csvLines[i].length > 0) {
        heya = csvLines[i].split(",");
        dates = heya[0].split(".");
        for (var j = 0; j <= HEYA_COUNT; j++) {
          hData[j] = heya[j+1].split("-");
          if (heya[j+1] !== "") {
            if (hData[j][0] === "") {
              dps[j].push({
                x: new Date(dates[0], dates[1] - 1),
                y: null
              });
              dpsB[j].push({
                x: new Date(dates[0], dates[1] - 1),
                y: null
              });
            }
            else if (hData[j][3] !== "") {
              dps[j].push({
                markerSize: 4,
                markerColor: "white",
                markerBorderColor: "black",
                markerBorderThickness: 1,
                shisho: hData[j][2],
                label: hData[j][3],
                prevHeyaName: hData[j][5],
                url: "https://sumodb.sumogames.de/Banzuke.aspx?b=" + dates[0] + 
                dates[1] + "&heya=" + hData[j][4] + "&shusshin=-1",
                x: new Date(dates[0], dates[1] - 1),
                y: parseInt(hData[j][0])
              });
              dpsB[j].push({
                markerSize: 4,
                markerColor: "white",
                markerBorderColor: "black",
                markerBorderThickness: 1,
                shisho: hData[j][2],
                label: hData[j][3],
                prevHeyaName: hData[j][5],
                url: "https://sumodb.sumogames.de/Banzuke.aspx?b=" + dates[0] + 
                dates[1] + "&heya=" + hData[j][4] + "&shusshin=-1",
                x: new Date(dates[0], dates[1] - 1),
                y: [parseInt(hData[j][0]), parseInt(hData[j][0]) -
                  parseInt(hData[j][1])
                ]
              });
            } else {
              dps[j].push({
                shisho: hData[j][2],
                label: hData[j][3],
                prevHeyaName: hData[j][5],
                url: "https://sumodb.sumogames.de/Banzuke.aspx?b=" + dates[0] + 
                dates[1] + "&heya=" + hData[j][4] + "&shusshin=-1",
                x: new Date(dates[0], dates[1] - 1),
                y: parseInt(hData[j][0])
              });
              dpsB[j].push({
                shisho: hData[j][2],
                label: hData[j][3],
                prevHeyaName: hData[j][5],
                url: "https://sumodb.sumogames.de/Banzuke.aspx?b=" + dates[0] + 
                dates[1] + "&heya=" + hData[j][4] + "&shusshin=-1",
                x: new Date(dates[0], dates[1] - 1),
                y: [parseInt(hData[j][0]), parseInt(hData[j][0]) -
                  parseInt(hData[j][1])
                ]
              });
            }
          }
        }
      }
    }
    chart.render();
  }
  
  var viewportButton = document.getElementById("setViewport");
  var vRange = document.getElementById("viewportRange");
  viewportButton.addEventListener("click", setViewport);

  //Function for setting viewport
  function setViewport() {
    var dates = minDates = maxDates = [];

    if (vRange.value) {
      dates = vRange.value.split("-");
      minDates = dates[0].split(".");
      maxDates = dates[1].split(".");
    }

    chart.axisX[0].set("viewportMinimum", new Date(minDates[0], minDates[1] - 1));
    chart.axisX[0].set("viewportMaximum", new Date(maxDates[0], maxDates[1] - 1));
    minXValue.setAttribute("value", 
      CanvasJS.formatDate(chart.axisX[0].viewportMinimum, "YYYY.MM"));
    maxXValue.setAttribute("value", 
      CanvasJS.formatDate(chart.axisX[0].viewportMaximum, "YYYY.MM"));
  }

  var resetViewportButton = document.getElementById("resetViewport");
  resetViewportButton.addEventListener("click", resetViewport);

  function resetViewport() {
    chart.axisX[0].set("viewportMinimum", null);
    chart.axisX[0].set("viewportMaximum", null);
    minXValue.setAttribute("value", 
      CanvasJS.formatDate(chart.axisX[0].viewportMinimum, "YYYY.MM"));
    maxXValue.setAttribute("value", 
      CanvasJS.formatDate(chart.axisX[0].viewportMaximum, "YYYY.MM"));
    vRange.value = "";
  }


  $(".period").click( function() {
    var period = this.id;
    var dates = [];

    dates = maxXValue.value.split(".");
    dates[0] = parseInt(dates[0]);
    
    switch(period) {
      case "5y":
        dates[0] = dates[0] - 5;
        break;
      case "10y":
        dates[0] = dates[0] - 10;
        break;
      case "20y":
        dates[0] = dates[0] - 20;
        break;
      default:
        dates[0] = dates[0] - 50;
    }
    
    chart.axisX[0].set("viewportMinimum", new Date(dates[0], dates[1] - 1));
    minXValue.setAttribute("value", 
      CanvasJS.formatDate(chart.axisX[0].viewportMinimum, "YYYY.MM"));
    maxXValue.setAttribute("value", 
      CanvasJS.formatDate(chart.axisX[0].viewportMaximum, "YYYY.MM"));
  });


  var labelsCheckbox = document.querySelector("input[name=labelsCheckbox]");
  labelsCheckbox.addEventListener("change", toggleLabels);

  function toggleLabels() {
    if (this.checked) {
      for (var i = 0; i <= HEYA_COUNT; i++) {
        chart.options.data[i].indexLabelFormatter = function(e) {
          return "";
        }
      }
    } else {
      for (var i = 0; i <= HEYA_COUNT; i++) {
        chart.options.data[i].indexLabelFormatter = getHeyaLabels;
      }
    }
    chart.render();
  }

}

    </script>
  </head>
  <body> 
    Viewing from: <input id="minXValue" type="text" placeholder="-" size="5" style="text-align: center; background-color:white;" readonly> 
    to: <input id="maxXValue" type="text" placeholder="-" size="5" style="text-align: center; background-color:white;" readonly> 
    Enter viewport range: <input id="viewportRange" type="text" placeholder="yyyy.m - yyyy.m"> 
    <button id="setViewport" type="button" value="viewportButton">Set</button>
    <button id="resetViewport" type="button" value="resetViewportButton">Reset</button>
    <div id="update-nav">
      <div id="range-selector">
        <input type="button" id="5y" class="period ui-button" value="5 yrs"/>
        <input type="button" id="10y" class="period ui-button" value="10 yrs"/>
        <input type="button" id="20y" class="period ui-button" value="20 yrs"/>
        <input type="button" id="50y" class="period ui-button" value="50 yrs"/>
      </div>
    </div>
    <div id="chartContainer" style="height: 600px; width: 100%;">
      <center>
        <img src="https://i.imgur.com/Pdr7Mvk.gif" id="loader" />
        <br />Loading...
      </center>
    </div>
    <label><input id="toggleSekitori" type="checkbox" name="checkbox" value="" style="float:left">Enable Sekitori</label>
    <div>
    <label><input id="toggleLabels" type="checkbox" name="labelsCheckbox" value="" style="float:left">Hide Labels</label>
    <div id="loadingText"></div>
    <span id="display"></span>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://canvasjs.com/assets/script/canvasjs.min.js"></script>
  </body>
</html>
