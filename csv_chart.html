<!DOCTYPE HTML>
<html>
<head>  
<script>
window.onload = function () {

    const HEYA_COUNT = 3;

    for (var i = 1; i <= HEYA_COUNT; i++) {
        this["dps" + i] = [];
    }
     
    var chart = new CanvasJS.Chart("chartContainer", {
        theme: "light1",
        backgroundColor: "transparent",
        animationEnabled: false,
        exportEnabled: true,
        zoomEnabled: true,
        zoomType: "x",

        title: {
            text: "Description"
        },
        axisY: {
            title: "rikishi number",
            labelFontSize: 14,
            titleFontSize: 20,
            titleFontColor: "blue",
            includeZero: true
        },
        axisX: {
            title: "date",
            labelFontSize: 14,
            titleFontSize: 20,
            titleFontColor: "blue",
            viewportMinimum: new Date(1988, 3),
            viewportMaximum: new Date(2022, 5),
            //margin: 30,
            includeZero: false,
            //labelFormatString: "YYYY MM"
            // interval: 6
            labelFormatter: function(e) {
                return CanvasJS.formatDate(e.value, "YYYY.MM");
            }   
        },
        legend: {
            cursor: "pointer",
            // dockInsidePlotArea: true,
            // itemclick: toggleDataSeries
            itemmouseover: function(e) {
                e.dataSeries.lineThickness = 2.5;
                //e.chart.data[e.dataSeriesIndex].lineThickness
                e.chart.render();
            },
            itemmouseout: function(e) {
                e.dataSeries.lineThickness = 1.5;
                e.chart.render();
            },
            itemclick: function(e) {

                if (e.dataSeries.name == "Dewanoumi Ichimon") {
                    if (typeof(e.dataSeries.visible) === "undefined" || e.dataSeries.visible) {
                    e.dataSeries.visible = false;
                    for (var i = 1; i <= 3; i++)
                        chart.options.data[i].visible = false;
                    } else {
                        e.dataSeries.visible = true;
                        for (var i = 1; i <= 3; i++)
                            chart.options.data[i].visible = true;
                    }
                }
                else if (typeof(e.dataSeries.visible) === "undefined" || e.dataSeries.visible) {
                    e.dataSeries.visible = false;
                } else {
                    e.dataSeries.visible = true;
                }
                
            }
        },
        toolTip: {
            shared: false,
            //cornerRadius: 10,
            fontFamily: "arial",
            borderColor: "black",
            contentFormatter: function(e) {
                var str = "";
                for (var i = 0; i < e.entries.length; i++) {
                    var  temp = CanvasJS.formatDate(e.entries[i].dataPoint.x, "YYYY.MM") + " - " + "<strong>" + e.entries[i].dataSeries.name + "</strong><br/>Shisho: " + e.entries[i].dataPoint.label + "<br/><strong>" + e.entries[i].dataPoint.y[0] + "</strong> rikishi, <strong>" + (e.entries[i].dataPoint.y[0] - e.entries[i].dataPoint.y[1]) + "</strong> sekitori<br/>";
                    str = str.concat(temp);
                }
                return str;
            }
        },
        data: [
        {
            name: "Dewanoumi Ichimon",
            type: "line",
            showInLegend: true,
            dataPoints: [{ x: 0 }]
        }, {
            indexLabelFormatter: function(e) {
                if (e.index == 0 && e.dataPoint.dataPointLabel)
                    return e.dataPoint.dataPointLabel;
                else return "";
            },
            type: "rangeArea", showInLegend: true, name: "Dewanoumi",
            fillOpacity: .4, lineThickness: 1.5, click: onClick,
            indexLabelFontSize: 14, dataPoints: dps1
        }, {
            indexLabelFormatter: function(e) {
                if (e.index == 0 && e.dataPoint.dataPointLabel)
                    return e.dataPoint.dataPointLabel;
                else return "";
            },
            type: "rangeArea", showInLegend: true, name: "Fujishima",
            fillOpacity: .4, lineThickness: 1.5, click: onClick,
            indexLabelFontSize: 14, dataPoints: dps2
        }, {
            indexLabelFormatter: function(e) {
                if (e.index == 0 && e.dataPoint.dataPointLabel)
                    return e.dataPoint.dataPointLabel;
                else return "";
            },
            type: "rangeArea", showInLegend: true, name: "Futagoyama",
            fillOpacity: .4, lineThickness: 1.5, click: onClick,
            indexLabelFontSize: 14, dataPoints: dps3
        }]
    });
    

    function onClick(e) {      
        window.open(e.dataPoint.url);    
    }


    


    var checkbox = document.querySelector("input[name=checkbox]");
    checkbox.addEventListener("change", toggleSekitori);

    function toggleSekitori() {
        var y1 = [];

        if (this.checked) {
            for (var i = 1; i <= 3; i++) {
                for (var j = 0; j < chart.options.data[i].dataPoints.length; j++) {
                    y1[j] = chart.options.data[i].dataPoints[j].y[1];
                    chart.options.data[i].dataPoints[j].y[1] = chart.options.data[i].dataPoints[j].y[0];
                }
            }
        }
    }


    var checkbox = document.querySelector("input[name=checkbox]");
    checkbox.addEventListener("change", smoothLines);

    function smoothLines() {
        if (this.checked) {
            for (var i = 1; i <=3; i++)
                chart.data[i].set("type", "rangeSplineArea");
        }
        else for (var i = 1; i <=3; i++) {
            chart.data[i].set("type", "rangeArea");
        }

        chart.render();
    }


    /*$("#slider1").slider({
        range: true,
        min: chart.axisX[0].get("minimum"),
        max: chart.axisX[0].get("maximum"),
        values: [1, 111], //Defalt zoom state
        slide: function(event, ui) {
            chart.axisX[0].set("viewportMinimum", ui.values[0], false);
            chart.axisX[0].set("viewportMaximum", ui.values[1]);    
        }
    });

    chart.axisX[0].set("viewportMinimum", $("#slider1").slider("values", 0), false);
    chart.axisX[0].set("viewportMaximum", $("#slider1").slider("values", 1));*/


    $.get("https://raw.githubusercontent.com/andre1670/sumo-heya-chart/main/chart.csv", getDataPointsFromCSV);
    
    function getDataPointsFromCSV(csv) {
        var csvLines = heya = date = [];
        for (var i = 1; i <= HEYA_COUNT; i++) {
            this["datas" + i] = [];
        }

        csvLines = csv.split(/[\r?\n|\r|\n]+/);
        for (var i = 1; i < csvLines.length; i++) {
            if (csvLines[i].length > 0) {
                heya = csvLines[i].split(",");
                date = heya[0].split(".");

                datas1 = heya[1].split("-");
                datas2 = heya[2].split("-");
                datas3 = heya[3].split("-");
                dps1.push({ label: datas1[2], dataPointLabel: datas1[3],
                    url: "https://sumodb.sumogames.de/Banzuke.aspx?b=" + date[0] + date[1] + "&heya=9&shusshin=-1",
                    x: new Date(date[0], date[1]-1), y: [parseInt(datas1[0]), parseInt(datas1[0]) - parseInt(datas1[1])] });
                dps2.push({ label: datas2[2], dataPointLabel: datas2[3],
                    url: "https://sumodb.sumogames.de/Banzuke.aspx?b=" + date[0] + date[1] + "&heya=" + datas2[4] + "&shusshin=-1",
                    x: new Date(date[0], date[1]-1), y: [parseInt(datas2[0]), parseInt(datas2[0]) - parseInt(datas2[1])] });
                dps3.push({ label: datas3[2], dataPointLabel: datas3[3],
                    url: "https://sumodb.sumogames.de/Banzuke.aspx?b=" + date[0] + date[1] + "&heya=14&shusshin=-1",
                    x: new Date(date[0], date[1]-1), y: [parseInt(datas3[0]), parseInt(datas3[0]) - parseInt(datas3[1])] });
            }
        }
        chart.render();
    }

    $("#updateDataPoint").click(function () {

        //var length = chart.options.data[0].dataPoints.length;
        //chart.options.title.text = "Last DataPoint Updated";
        var y1 = [];
        for (var i = 1; i <= 3; i++) {
            for (var j = 0; j < chart.options.data[i].dataPoints.length; j++) {
                y1[j] = chart.options.data[i].dataPoints[j].y[1];
                chart.options.data[i].dataPoints[j].y[1] = chart.options.data[i].dataPoints[j].y[0];
            }
        }
        chart.render();

    });
}

</script>
</head>
<body>
<div id="chartContainer" style="height: 450px; width: 100%;">
<center><img src="https://i.imgur.com/Pdr7Mvk.gif" id="loader"/><br/>Loading...</center>
</div><label><input id="smoothLines" type = "checkbox" name="checkbox" value="">Smooth Lines</label>
</div><label><input id="toggleSekitori" type = "checkbox" name="checkbox" value="">Enable Sekitori</label>
<button id="updateDataPoint">Update Data Point</button>
<span id="display"></span>
<script type="text/javascript" src="https://canvasjs.com/assets/script/jquery-1.11.1.min.js"></script>
<script src="https://canvasjs.com/assets/script/canvasjs.min.js"></script>
</body>
</html>
