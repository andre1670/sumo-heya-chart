<!DOCTYPE HTML>
<html>

<head>
  <script>

window.onload = function() {

  const HEYA_COUNT = 3;
  var ichimonDps = [];

  // Initialize array of dataPoint arrays with sekitori
  var dps = Create2DArray(HEYA_COUNT);

  // Initialize array of dataPoint arrays with no sekitori
  var dpsB = Create2DArray(HEYA_COUNT);

  var chart = new CanvasJS.Chart("chartContainer", {
    //theme: "light2",
    backgroundColor: "transparent",
    animationEnabled: false,
    exportEnabled: true,
    zoomEnabled: true,
    zoomType: "x",

    title: {
      text: "Description",
      fontFamily: "Verdana"
    },

    axisX: {
      title: "date",
      titleFontFamily: "Verdana",
      labelFontFamily: "Arial",
      labelFontSize: 14,
      titleFontSize: 20,
      titleFontColor: "red",
      tickLength: 5,
      tickColor: "black",
      lineColor: "black",
      //margin: 10,
      //labelFormatString: "YYYY MM"
      //interval: 5,
      //intervalType: "year",
      labelFormatter: function(e) {
        return CanvasJS.formatDate(e.value, "YYYY.MM");
      },
      stripLines: [{
        //value: new Date(1988, 1),
        startValue: new Date(1898, 4),
        endValue: new Date(1988, 1),               
        color: "red",
        opacity: .1
      }, {
        startValue: new Date(1898, 4),
        endValue: new Date(1934, 2),               
        color: "red",
        opacity: .1
      }, {
        value: new Date(1957, 11),
        label: "6BPY era starts"
      }],
      crosshair: {
        enabled: true,
        labelFormatter: function(e) {
          return CanvasJS.formatDate(e.value, "YYYY.MM");
        }
      }
    },

    axisY: {
      title: "total rikishi",
      titleFontFamily: "Verdana",
      labelFontFamily: "arial",
      labelFontSize: 14,
      titleFontSize: 20,
      titleFontColor: "red",
      includeZero: true,
      tickLength: 0,
      lineColor: "black",
      gridColor: "#A9A9A9",
      minimum: 0
    },

    legend: {
      cursor: "pointer",
      fontFamily: "Trebuchet MS",
      fontWeight: "bold ",
      horizontalAlign: "center",
      //itemWidth: 110,
      //dockInsidePlotArea: true,
      itemmouseover: function(e) {
        e.dataSeries.lineThickness = 3;
        e.dataSeries.fillOpacity = .5;
        e.dataSeries.indexLabelFontWeight = "bold";
        e.chart.render();
      },
      itemmouseout: function(e) {
        e.dataSeries.lineThickness = 2;
        e.dataSeries.fillOpacity = .4;
        e.dataSeries.indexLabelFontWeight = "normal";
        e.chart.render();
      },
      itemclick: function(e) {
        if (e.dataSeries.name === "Dewanoumi Ichimon") {
          if (e.dataSeries.visible) {
            e.dataSeries.visible = false;
            for (var i = 1; i < HEYA_COUNT + 1; i++)
              chart.options.data[i].visible = false;
          } else {
            e.dataSeries.visible = true;
            for (var i = 1; i < HEYA_COUNT + 1; i++)
              chart.options.data[i].visible = true;
          }
        } else if (e.dataSeries.visible)
          e.dataSeries.visible = false;
        else
          e.dataSeries.visible = true;
        e.chart.render();
      }
    },

    toolTip: {
      shared: false,
      fontSize: 13,
      cornerRadius: 8,
      fontFamily: "Verdana",
      //borderColor: "black",
      contentFormatter: tooltipNoSekitori
    },

    data: [{
      name: "Dewanoumi Ichimon",
      legendText: "- {name} -",
      type: "rangeArea",
      showInLegend: true,
      toolTipContent: " ",
      highlightEnabled: false,
      legendMarkerType: "none",
      markerSize: 0,
      visible: true,
      dataPoints: ichimonDps
    }, {
      name: "Dewanoumi",
      type: "spline",
      dataPoints: dpsB[0]
    }, {
      name: "Fujishima",
      type: "spline",
      dataPoints: dpsB[1]
    }, {
      name: "Futagoyama",
      type: "spline",
      markerSize: 0,  // For heya with 0 sekitori throughout
                      // Without it, the markers appear on all of its dataPoints
      dataPoints: dpsB[2]
    }]
  });


  for (var i = 1; i < HEYA_COUNT + 1; i++)
    configureDataSeries(i);

  function configureDataSeries(i) {
    chart.options.data[i].cursor = "pointer";
    chart.options.data[i].showInLegend = true;
    chart.options.data[i].fillOpacity = .4;
    chart.options.data[i].lineThickness = 2;
    chart.options.data[i].indexLabelFontSize = 12;
    chart.options.data[i].indexLabelLineThickness = 1.5;
    chart.options.data[i].indexLabelLineColor = "black";
    chart.options.data[i].legendMarkerType = "circle";
    chart.options.data[i].visible = true;
    chart.options.data[i].indexLabelLineDashType = "dot";
    chart.options.data[i].indexLabelFormatter = getHeyaLabel;
    chart.options.data[i].click = openLink;
  }


  // Returns HB and HT labels
  function getHeyaLabel(e) {
    if (e.index !== 1 && e.dataPoint.label)
      return e.dataPoint.label;
    else return "";
  }


  // Opens link of particular basho and/or heya
  function openLink(e) {
    window.open(e.dataPoint.url);
  }


  function Create2DArray(rows) {
    var arr = [];

    for (var i = 0; i < rows; i++) {
       arr[i] = [];
    }

    return arr;
  }

  // Checkbox for toggling between sekitori and sekitoriless dataSeries
  var sekitoriCheckbox = document.querySelector("input[name=checkbox]");
  sekitoriCheckbox.addEventListener("change", toggleSekitori);

  function toggleSekitori() {
    if (this.checked) {
      for (var i = 1; i < HEYA_COUNT + 1; i++) {
        chart.data[i].set("type", "rangeSplineArea");
        chart.options.data[i].dataPoints = dps[i-1];
      }
      chart.options.toolTip.contentFormatter = tooltipSekitori;
    } else {
      for (var i = 1; i < HEYA_COUNT + 1; i++) {
        chart.data[i].set("type", "spline");
        chart.options.data[i].dataPoints = dpsB[i-1];
      }
      chart.options.toolTip.contentFormatter = tooltipNoSekitori;
    }
    chart.render();
  }


  function tooltipNoSekitori(e) {
    var str = "";

    for (var i = 0; i < e.entries.length; i++) {
      var temp = CanvasJS.formatDate(e.entries[i].dataPoint.x, "YYYY.MM") + 
      " - <strong>" + e.entries[i].dataSeries.name + 
      "</strong><br/>Shisho: " + e.entries[i].dataPoint.shisho + 
      "<br/><strong>" + e.entries[i].dataPoint.y + "</strong> rikishi";
      str = str.concat(temp);
    }

    return str;
  }


  function tooltipSekitori(e) {
    var str = "";

    for (var i = 0; i < e.entries.length; i++) {
      var temp = CanvasJS.formatDate(e.entries[i].dataPoint.x, "YYYY.MM") + 
      " - <strong>" + e.entries[i].dataSeries.name + "</strong><br/>Shisho: " + 
      e.entries[i].dataPoint.shisho + "<br/><strong>" + 
      e.entries[i].dataPoint.y[0] + "</strong> rikishi, <strong>" + 
      (e.entries[i].dataPoint.y[0] - e.entries[i].dataPoint.y[1]) + 
      "</strong> sekitori<br/>";
      str = str.concat(temp);
    }

    return str;
  }


  $.get("https://raw.githubusercontent.com/andre1670/andre1670/main/chart.csv", 
    getDataPointsFromCSV);

  function getDataPointsFromCSV(csv) {
    var csvLines = heya = date = [];
    var datas = Create2DArray(HEYA_COUNT);

    csvLines = csv.split(/[\r?\n|\r|\n]+/);
    for (var i = 1; i < csvLines.length; i++) {
      if (csvLines[i].length > 0) {
        heya = csvLines[i].split(",");
        date = heya[0].split(".");

        for (var j = 0; j < HEYA_COUNT; j++) {
          datas[j] = heya[j+1].split("-");
          if (heya[j+1] !== "") {
            dps[j].push({
              shisho: datas[j][2],
              label: datas[j][3],
              url: "https://sumodb.sumogames.de/Banzuke.aspx?b=" + date[0] + 
              date[1] + "&heya=" + datas[j][4] + "&shusshin=-1",
              x: new Date(date[0], date[1] - 1),
              y: [parseInt(datas[j][0]), parseInt(datas[j][0]) - 
              parseInt(datas[j][1])]
            });
            dpsB[j].push({
              shisho: datas[j][2],
              label: datas[j][3],
              url: "https://sumodb.sumogames.de/Banzuke.aspx?b=" + date[0] + 
              date[1] + "&heya=" + datas[j][4] + "&shusshin=-1",
              x: new Date(date[0], date[1] - 1),
              y: parseInt(datas[j][0])
            });
            if (i === csvLines.length - 2) {
              ichimonDps.push({
                x: new Date(date[0], date[1] - 1),
                y: [0, 0]
              });
            }
          }
        }
      }
    }
    chart.render();
  }


  var axisXMin = chart.axisX[0].get("minimum");
  var axisXMax = chart.axisX[0].get("maximum");

  $( function() {
    $("#fromDate").val(axisXMin);
    $("#toDate").val(axisXMax);
    $("#fromDate").datepicker({dateFormat: "M yy"});
    $("#toDate").datepicker({dateFormat: "M yy"});
  });

  $("#date-selector").change( function() {
    var minValue = $( "#fromDate" ).val();
    var maxValue = $ ( "#toDate" ).val();
    
    if(new Date(minValue).getTime() < new Date(maxValue).getTime()){  
      chart.axisX[0].set("viewportMinimum", minValue);
      chart.axisX[0].set("viewPortMaximum", maxValue);
    }  
  });

  $(".period").click( function() {
    var period = this.id;  
    var minValue;
    minValue = new Date(axisXMax);
    
    switch(period){
      case "1m":
        minValue.setMonth(minValue.getMonth() - 1);
        break;
      case "3m":
        minValue.setMonth(minValue.getMonth() - 3);
        break;
      case "6m":
        minValue.setMonth(minValue.getMonth() - 6);
        break;
      case "5y":
        minValue.setYear(minValue.getFullYear() - 5);
        break;
      default:
        minValue = axisXMin;
    }
    
    chart.axisX[0].set("minimum", new Date(minValue), true);  
    chart.axisX[0].set("maximum", new Date(axisXMax), true);
  });

}

    </script>
</head>

<body>
  <div id="update-nav">
  <div id="range-selector">
    <input type="button" id="1m" class="period ui-button" value="1m" />
    <input type="button" id="3m" class="period ui-button" value="3m"/>
    <input type="button" id="6m" class="period ui-button" value="6m"/>
    <input type="button" id="5y" class="period ui-button" value="5y"/>
    <input type="button" id="all" class="period ui-button" value="All"/>
  </div>
  <div id="date-selector" class="">
      From:<input type="text" id="fromDate"  class="ui-widget">
      To:<input type="text" id="toDate"  class="ui-widget">
  </div>
  </div>
  <div id="chartContainer" style="height: 450px; width: 100%;">
    <center><img src="https://i.imgur.com/Pdr7Mvk.gif" id="loader"/><br/>Loading...</center>
  </div><label><input id="toggleSekitori" type="checkbox" name="checkbox" value="">Enable Sekitori</label>
  <button id="button">Get Chart Type</button>
  <span id="display"></span>
  <script type="text/javascript" src="https://canvasjs.com/assets/script/jquery-1.11.1.min.js"></script>
  <script src="https://canvasjs.com/assets/script/canvasjs.min.js"></script>
</body>

</html>
